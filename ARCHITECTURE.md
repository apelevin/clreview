# Архитектура решения

## Обзор

Решение представляет собой веб-сервис для автоматической обработки судебных документов и генерации обзоров судебной практики. Система построена на Next.js (App Router) с использованием TypeScript и OpenRouter API для обработки документов через многошаговый pipeline.

---

## Высокоуровневая архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Next.js)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Document   │  │  Processing  │  │    Review    │     │
│  │    Upload    │  │    Status    │  │   Display    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Cost Statistics Component              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              API Routes (Next.js Server)                     │
│  ┌──────────────┐              ┌──────────────┐            │
│  │ /api/upload  │              │ /api/process │            │
│  └──────────────┘              └──────────────┘            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Core Library (lib/)                             │
│  ┌──────────────────┐  ┌──────────────────┐                 │
│  │ docx-to-markdown │  │   llm-client    │                 │
│  └──────────────────┘  └──────────────────┘                 │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              pipeline.ts (5-step pipeline)           │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              External Services                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              OpenRouter API                          │   │
│  │  - x-ai/grok-4.1-fast (Step 0)                      │   │
│  │  - google/gemini-2.5-flash-lite-preview-09-2025     │   │
│  │    (Step 1)                                         │   │
│  │  - deepseek/deepseek-v3.2 (Step 3)                  │   │
│  │  - google/gemini-2.5-flash-preview-09-2025 (Step 4) │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Storage (File System)                           │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │   uploads/   │  │  processed/ │                         │
│  │  (DOCX files)│  │ (results by │                         │
│  │              │  │   session)  │                         │
│  └──────────────┘  └──────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

---

## Поток данных (Data Flow)

### 5-шаговый Pipeline обработки

```
Шаг 0: Извлечение правовых позиций (параллельно для всех документов)
  DOCX → Markdown → 10-level Legal Position (JSON) + номер дела
  Модель: x-ai/grok-4.1-fast
  
  Вход: DOCX файлы
  Выход: LegalPosition[] (10 уровней структурированных данных, включая номер дела)

┌─────────────────────────────────────────────────────────────┐

Шаг 1: Локальное сжатие (параллельно для всех позиций)
  Legal Position → Case Card (компактный JSON с номером дела)
  Модель: google/gemini-2.5-flash-lite-preview-09-2025
  
  Вход: LegalPosition[]
  Выход: CaseCard[] (краткие карточки дел с номерами дел)

┌─────────────────────────────────────────────────────────────┐

Шаг 2: Группировка (формальный шаг)
  Case Cards → Grouped Case Cards
  Без LLM вызова
  
  Вход: CaseCard[]
  Выход: CaseCard[] (все в одном кластере)

┌─────────────────────────────────────────────────────────────┐

Шаг 3: Агрегация (последовательно)
  Case Cards → Review Skeleton (структурированный JSON)
  Модель: deepseek/deepseek-v3.2
  
  Вход: CaseCard[] (с номерами дел)
  Выход: ReviewSkeleton (матрица подходов, расхождения, тренды)

┌─────────────────────────────────────────────────────────────┐

Шаг 4: Генерация финального обзора (последовательно)
  Review Skeleton → Final Review (читаемый текст с цитированием номеров дел)
  Модель: google/gemini-2.5-flash-preview-09-2025
  
  Вход: ReviewSkeleton + CaseCard[] (с номерами дел)
  Выход: Review (Markdown текст для юристов с цитированием номеров дел)
```

---

## Структура данных

### LegalPosition (10 уровней)
Структурированное представление правовой позиции из судебного документа:
- **Level 1**: Отрасль права, категория спора, номер дела (`case_number`)
- **Level 2**: Стороны, тип отношений
- **Level 3**: Основные и вторичные требования
- **Level 4**: Ключевые и вторичные нормы
- **Level 5**: Ключевые и спорные факты
- **Level 6**: Шаги рассуждений, особенности толкования
- **Level 7**: Краткое решение, область применения, результат
- **Level 8-10**: Риски (прямые, аналогичные, операционные)

### CaseCard
Компактная карточка дела:
- `caseNumber`: Номер дела для цитирования в обзоре
- `summary`: Краткая фабула и предмет спора (1-2 строки)
- `keyFindings`: Ключевые правовые выводы (3-5 буллетов)
- `appliedNorms`: Применённые нормы (1-2 строки)
- `result`: Результат (удовлетворено/отказано/частично)

### ReviewSkeleton
Структурированный скелет обзора:
- `legalQuestion`: Правовой вопрос
- `normativeBase`: Нормативная база
- `approaches`: Массив подходов судов с описанием и примерами дел
- `discrepancies`: Расхождения в толковании, требованиях к доказательствам, оценке фактов
- `trends`: Доминирующие подходы, временные сдвиги, роль высших судов

### Review
Финальный читаемый документ в формате Markdown для практикующих юристов.

---

## Технические компоненты

### Frontend (`app/`)

#### `app/page.tsx`
Главная страница приложения:
- Управление состоянием загрузки и обработки
- Координация компонентов
- Обработка результатов pipeline

#### `app/components/DocumentUpload.tsx`
Компонент загрузки документов:
- Drag & drop интерфейс
- Валидация формата (.docx)
- Отправка файлов на `/api/upload`

#### `app/components/ProcessingStatus.tsx`
Отображение статуса обработки:
- Прогресс по шагам pipeline
- Сообщения о текущем этапе
- Обработка ошибок

#### `app/components/ReviewDisplay.tsx`
Отображение финального обзора:
- Рендеринг Markdown с использованием библиотеки `react-markdown`
- Поддержка всех элементов Markdown (заголовки, списки, жирный текст, код и т.д.)
- Интеграция с CostStatistics

#### `app/components/CostStatistics.tsx`
Детальная статистика расходов:
- Стоимость по каждому шагу
- Использование токенов (input, cached, output)
- Информация о модели
- Общая статистика

### Backend API (`app/api/`)

#### `app/api/upload/route.ts`
Эндпоинт загрузки файлов:
- Приём множественных DOCX файлов
- Сохранение в `uploads/` с timestamp
- Возврат списка сохранённых файлов

#### `app/api/process/route.ts`
Эндпоинт обработки документов:
- Чтение файлов из `uploads/`
- Вызов `processDocumentsPipeline()`
- Возврат результатов с cost statistics

### Core Library (`lib/`)

#### `lib/docx-to-markdown.ts`
Конвертация DOCX в Markdown:
- Использует библиотеку `mammoth`
- Поддержка работы с файлами и буферами
- Обработка предупреждений при конвертации

#### `lib/llm-client.ts`
Клиент для работы с OpenRouter API:

**Основные функции:**
- `getOpenAIClient()`: Ленивая инициализация клиента OpenRouter
- `callOpenAI()`: Вызов API с поддержкой:
  - Динамический выбор модели
  - Расчёт стоимости на основе использования токенов

**Ценообразование:**
- `MODEL_PRICING`: Цены для моделей OpenRouter (за токен, не за 1M токенов!)
- Отдельный учёт input, cached input, output токенов
- Цены умножаются напрямую на количество токенов
- Модели используют префиксы провайдеров (например, `x-ai/grok-4.1-fast`, `google/gemini-2.5-flash-preview-09-2025`)

**Возвращаемые данные:**
- `content`: Текст ответа
- `usage`: Статистика токенов
- `cost`: Детализация расходов

#### `lib/pipeline.ts`
Основной pipeline обработки документов:

**Функции шагов:**
- `processDocumentStep0()`: DOCX → Markdown → Legal Position (с извлечением номера дела)
- `processStep1()`: Legal Position → Case Card (с передачей номера дела)
- `processStep2()`: Формальная группировка
- `processStep3()`: Case Cards → Review Skeleton (с номерами дел в контексте)
- `processStep4()`: Review Skeleton → Final Review (с цитированием номеров дел)

**`processDocumentsPipeline()`:**
- Оркестрация всех шагов
- Параллельная обработка на шагах 0 и 1
- Последовательная обработка на шагах 3 и 4
- Сбор статистики расходов по каждому шагу
- Callback для отслеживания прогресса
- Сохранение промежуточных результатов

**Сохранение результатов (`saveResults()`):**
- Создание директории по timestamp сессии
- Сохранение для каждого документа:
  - `markdown.md` (исходный документ в Markdown)
  - `legal-position.json` (10-уровневая позиция с номером дела в level1.case_number)
  - `case-card.json` (карточка дела с номером дела в поле caseNumber)
- Сохранение `review-skeleton.json` и `review.md` (финальный обзор с цитированием номеров дел)

---

## Оптимизация затрат

### Выбор моделей по шагам

| Шаг | Модель                                              | Обоснование                                    |
|-----|-----------------------------------------------------|------------------------------------------------|
| 0   | x-ai/grok-4.1-fast                                  | Простое извлечение структурированных данных   |
| 1   | google/gemini-2.5-flash-lite-preview-09-2025        | Простое сжатие структурированных данных       |
| 2   | -                                                   | Формальный шаг, без LLM                        |
| 3   | deepseek/deepseek-v3.2                              | Сложная аналитика и агрегация                  |
| 4   | google/gemini-2.5-flash-preview-09-2025              | Генерация финального текста высокого качества |

### Механизмы надёжности

При недоступности указанной модели (404) запрос завершается с ошибкой.

---

## Хранение данных

### Структура директорий

```
uploads/
  ├── {timestamp}-{originalFileName}.docx
  └── ...

processed/
  └── {sessionTimestamp}/
      ├── {documentId}/
      │   ├── markdown.md
      │   ├── legal-position.json
      │   └── case-card.json
      ├── review-skeleton.json
      └── review.md
```

### Формат сохранения

- **Markdown**: Промежуточные результаты конвертации
- **JSON**: Структурированные данные (Legal Position, Case Card, Review Skeleton)
- **Markdown**: Финальный обзор для чтения

---

## Промпты (`prompts/`)

Система использует разделение промптов на SYSTEM и USER части:

- **`step0-prompt.md`**: Извлечение 10-уровневой правовой позиции и номера дела
- **`step1-prompt.md`**: Сжатие позиции в карточку дела с передачей номера дела
- **`step3-prompt.md`**: Агрегация карточек в скелет обзора
- **`step4-prompt.md`**: Генерация финального обзора с обязательным цитированием номеров дел

Формат промптов:
```markdown
## 🟦 **SYSTEM PROMPT**

{системный промпт}

---

## 🟩 **USER PROMPT**

{пользовательский промпт}
```

---

## Зависимости

### Основные библиотеки

- **Next.js 16.0.7**: React framework с App Router
- **TypeScript 5.9.3**: Типизация
- **OpenAI SDK 6.10.0**: Работа с OpenRouter API (совместимый формат)
- **Mammoth 1.11.0**: Конвертация DOCX → Markdown
- **Formidable 3.5.4**: Обработка загрузки файлов
- **Tailwind CSS 4.1.17**: Стилизация UI
- **react-markdown 10.1.0**: Рендеринг Markdown в React компонентах

---

## Обработка ошибок

### Уровни обработки ошибок

1. **Уровень компонента**: Отображение ошибок пользователю
2. **Уровень API**: Валидация входных данных, обработка ошибок pipeline
3. **Уровень Pipeline**: Частичные результаты при ошибках отдельных документов
4. **Уровень LLM Client**: Retry, fallback, логирование

### Стратегия восстановления

- Продолжение обработки при ошибках отдельных документов
- Сохранение частичных результатов
- Детальное логирование для отладки

---

## Масштабируемость

### Текущие ограничения

- Обработка файлов в памяти (буферы)
- Файловая система для хранения
- Синхронная обработка на шагах 3-4

### Потенциальные улучшения

- Очередь задач для асинхронной обработки
- База данных для хранения результатов
- Кэширование промежуточных результатов
- Batch API для массовой обработки
- Server-Sent Events для real-time прогресса

---

## Безопасность

### Текущие меры

- Валидация формата файлов (.docx)
- Ограничение размера запроса (Next.js по умолчанию)
- Переменные окружения для API ключей

### Рекомендации

- Ограничение размера файлов
- Санитизация имён файлов
- Rate limiting для API endpoints
- Аутентификация и авторизация пользователей

